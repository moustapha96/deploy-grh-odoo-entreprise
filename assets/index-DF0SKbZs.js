import{u as L,O as A,m as P,n as b,U as i,Q as E,j as e,X as R,R as v,V as S,W as k,Y as T,P as M}from"./index-Bbm31QRN.js";import{P as O}from"./PasswordFormInput-DoJAa4B0.js";import{T as U}from"./TextFormInput-DDVPbDBV.js";import{r as m,h as q,i as _}from"./vendor-DvxF9bYu.js";import{o as z}from"./yup-CBYd5xIv.js";import{u as C}from"./resolvers-feI25x5d.js";const W=()=>{const{saveSession:a,isAuthenticated:h}=L(),[l,s]=m.useState(!1),c=q(),[t]=_(),{urlApi:d}=m.useContext(A),u=P({email:b().email("Veuillez entrer un email valide").required("Veuillez entrer votre email"),password:b().required("Veuillez entrer votre mot de passe")}),{control:p,handleSubmit:r,reset:x,setValue:g}=C({resolver:z(u),defaultValues:{email:"",password:""}}),j=o=>o?o.role==="main_user"?"/admin/dashboard":o.role==="secondary_user"&&o.email==="alhussein.khouma@ccbm.sn"?"/gestion/dashboard":"/auth/sign-in":"/auth/sign-in",n=r(async o=>{s(!0);try{console.log("Attempting login with:",o.email);const w=await(await fetch(d+"auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:o.email,password:o.password})})).json();if(w.error){i.error(w.error,{position:"top-right",duration:3e3}),s(!1);return}const{user_info:V,access_token:F,parent:N}=w,y=t.get("redirectTo")??j(V);if(y==="/auth/sign-in")return i.error("RH non trouvée",{position:"top-right",duration:3e3}),x(),s(!1),c("/auth/sign-in");if(!N||N.id===null)return i.error("Vous n'êtes pas encore un responsable dans une entreprise.",{position:"top-right",duration:3e3}),await a(null),s(!1),c("/auth/sign-in");if(!F)throw new Error("Token d'accès non trouvé dans la réponse");if(!await a(w)){console.error("Failed to save session"),s(!1);return}i.success("Connexion réussie. Redirection...",{position:"top-right",duration:2e3}),setTimeout(()=>{window.location.href=y,s(!1)},100)}catch(f){console.error("Erreur lors de la connexion:",f),i.error("Une erreur s'est produite lors de la connexion.",{position:"top-right",duration:3e3}),s(!1)}});return{loading:l,login:n,control:p,reset:x,setValue:g}},$=P({password:b().min(8,"Le mot de passe doit contenir au moins 8 caractères").required("Veuillez entrer un mot de passe"),confirmPassword:b().oneOf([E("password")],"Les mots de passe ne correspondent pas").required("Veuillez confirmer votre mot de passe")});function D({show:a,email:h,onClose:l}){const[s,c]=m.useState(!1),[t,d]=m.useState(!1),{register:u,handleSubmit:p,formState:{errors:r}}=C({resolver:z($),defaultValues:{password:"",confirmPassword:""}}),x=async g=>{c(!0);const j={email:h,password:g.password};try{const n=await T(j);console.log(n),await new Promise(f=>setTimeout(f,1e3)),l(),i.success("Votre mot de passe a été modifié avec succès");const o=new URL(window.location.href);o.searchParams.delete("mail"),window.history.replaceState({},document.title,o.toString())}catch(n){n.status===404?i.error(n.message):n.status===400&&i.error(n.response.data)}finally{c(!1)}};return a?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",children:e.jsxs("div",{className:"relative w-full max-w-md rounded-lg bg-zinc-800 p-6 shadow-lg",children:[e.jsx("button",{onClick:l,className:"absolute right-4 top-4 text-zinc-400 hover:text-white",children:e.jsx(R,{size:20})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-bold text-white",children:"Créer votre mot de passe"}),e.jsx("p",{className:"mt-2 text-sm text-zinc-400",children:"Votre compte vient d'etre créé . Veuillez définir votre mot de passe."})]}),e.jsxs("form",{onSubmit:p(x),children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"password",className:"block text-base/normal text-zinc-200 font-semibold",children:"Nouveau mot de passe"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{id:"password",type:t?"text":"password",...u("password"),className:"mt-1 block w-full rounded border-white/10 bg-transparent py-2.5 text-white/80 focus:border-white/25 focus:outline-0 focus:ring-0"}),e.jsx("button",{type:"button",onClick:()=>d(!t),className:"absolute inset-y-0 right-0 flex items-center pr-3",children:t?e.jsx(v,{size:20}):e.jsx(S,{size:20})})]}),r.password&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.password.message})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("label",{htmlFor:"confirmPassword",className:"block text-base/normal text-zinc-200 font-semibold",children:"Confirmer le mot de passe"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{id:"confirmPassword",type:t?"text":"password",...u("confirmPassword"),className:"mt-1 block w-full rounded border-white/10 bg-transparent py-2.5 text-white/80 focus:border-white/25 focus:outline-0 focus:ring-0"}),e.jsx("button",{type:"button",onClick:()=>d(!t),className:"absolute inset-y-0 right-0 flex items-center pr-3",children:t?e.jsx(v,{size:20}):e.jsx(S,{size:20})})]}),r.confirmPassword&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.confirmPassword.message})]}),e.jsxs("div",{className:"mb-4 flex items-center",children:[e.jsx("input",{id:"showPassword",type:"checkbox",checked:t,onChange:()=>d(!t),className:"h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("label",{htmlFor:"showPassword",className:"ml-2 block text-sm text-zinc-200",children:"Afficher les mots de passe"})]}),e.jsxs("button",{type:"submit",disabled:s,className:"inline-flex w-full items-center justify-center rounded bg-blueLogo px-6 py-2.5 text-white backdrop-blur-2xl transition-all hover:text-white",children:[s?"Chargement...":"Créer le mot de passe",s&&e.jsx(k,{className:"ml-2 animate-spin"})]})]})]})}):null}const I=()=>{const{loading:a,login:h,control:l,setValue:s}=W(),[c,t]=m.useState(!1),[d,u]=m.useState(""),r=new URLSearchParams(window.location.search).get("mail");return m.useEffect(()=>{r!==null&&(u(r),console.log(r),s("email",r),t(!0))},[r]),e.jsxs(e.Fragment,{children:[e.jsx(M,{title:"Connexion"}),e.jsxs("form",{className:"mt-2 shrink",onSubmit:h,children:[e.jsx(U,{containerClassName:"mb-4",label:"Adresse email",name:"email",labelClassName:"block text-base/normal text-zinc-200 font-semibold",className:"block rounded border-white/10 bg-transparent py-2.5 text-white/80 focus:border-white/25 focus:outline-0 focus:ring-0",fullWidth:!0,control:l}),e.jsx(O,{label:"Mot de passe",containerClassName:"mb-4",name:"password",labelClassName:"block text-base/normal text-zinc-200 font-semibold",fullWidth:!0,className:"block w-full rounded border-white/10 py-2.5 bg-transparent text-white/80 focus:border-white/25 focus:outline-0 focus:ring-0",control:l}),e.jsx("div",{className:"mb-6 flex flex-wrap items-center justify-between gap-x-1 gap-y-2",children:e.jsx("div",{})}),e.jsx("div",{className:"text-center text-sm justify-between ",children:e.jsxs("button",{type:"submit",disabled:a,className:"group mt-5 inline-flex w-2/3 items-center justify-center rounded bg-blueLogo px-6 py-2.5 text-white backdrop-blur-2xl transition-all hover:text-white",children:[a?"Chargement...":"Se connecter",a&&e.jsx(k,{className:"ml-2 animate-spin"})]})})]}),e.jsx("br",{}),e.jsx(D,{show:c,email:d,onClose:()=>t(!1)})]})};export{I as default};
